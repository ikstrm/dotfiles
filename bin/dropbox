#!/usr/bin/env bash

DROPBOX_DIR="${HOME}/Dropbox"

if [ $GOPATH != "/Users/k0kubun" ]; then
  echo "Unexpected \$GOPATH: ${GOPATH}. Refactor this script."
  exit 1
fi

if [ ! -e $DROPBOX_DIR ]; then
  echo "${DROPBOX_DIR} does not exist. Aborting."
  exit 1
fi

if ! pgrep -q Dropbox; then
  echo 'Dropbox process does not exist. Aborting.'
  exit 1
fi

if ! git rev-parse --show-toplevel > /dev/null; then
  exit 1
fi

# FIXME: I want to gsub $GOPATH from repo path
ghq_path="$(git rev-parse --show-toplevel | sed -e 's/^\/Users\/k0kubun\///g')"

gopath_repo="$(git rev-parse --show-toplevel)"
dropbox_repo="${DROPBOX_DIR}/${ghq_path}"

if echo $ghq_path | grep -v -q "\/github.com\/"; then
  echo "This is not hosted on GitHub. Aborting."
  exit 1
fi

case $1 in
  '')
    echo 'Usage dropbox [push|pull]'
    ;;
  'push')
    mkdir -p $dropbox_repo
    rm -rf $dropbox_repo
    cp -r $gopath_repo $dropbox_repo

    echo "Dropbox pushed"
    echo "from: ${gopath_repo}"
    echo "to:   ${dropbox_repo}"
    ;;
  'pull')
    echo 'Not Implemented'
    ;;
esac
